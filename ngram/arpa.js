function e(e){return new Promise(((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error)}))}async function t(e,t){async function n(t,o){let r;if(o||(o={orders:new Map}),r=t.match(/^ngram (\d+)=(\d+)/))o.orders.set(Number(r[1]),Number(r[2]));else if(r=t.match(/^\\(\d+)-grams:/))return await e.beginLoad(o.orders.size),e=>s(1,e);return e=>n(e,o)}async function s(t,n,o){let r;if(r=n.match(/^\s*-?(\d+|\.\d+)/)){const s=n.trim().split(/\s+/),o=Number(s.shift()),r=s.length>t?Number(s.pop()):void 0;s.some((e=>e.match(/[_<>]/)))||await e.addNGram(s,o,r)}else{if(r=n.match(/^\\(\d+)-grams:/))return e=>s(Number(r[1]),e);if(r=n.match(/^\\end\\/))return await e.endLoad(),function e(t){return e}}return e=>s(t,e)}let o=e=>n(e);for await(const e of async function*(e){let t="";const n=/([^\n]*)\n/gm,s=e.pipeThrough(new TextDecoderStream).pipeThrough(new TransformStream({transform(e,s){t+=e;let o=0;for(const e of t.matchAll(n))s.enqueue(e[1]),o+=e[0].length;t=t.substring(o)},flush(e){t&&e.enqueue(t)}})).getReader();let o;for(;!(o=await s.read()).done;)yield o.value}(t))o=await o(e);return e}const n=new class{#e;#t=0;#n;#s=[];#o=new Map;#r=[];#i;#a=Promise.resolve();#l=0;constructor(t){this.#e=t,this.#n=e(indexedDB.open(t)).then((async t=>{if(this.#t=t.objectStoreNames.length,Array.from(t.objectStoreNames).includes("1")){const n=t.transaction("1","readonly").objectStore("1");this.#s=await e(n.getAll()),this.#s.forEach((({nGram:[e]},t)=>{this.#o.set(e,t)}))}return t}))}close(){return this.#n.then((e=>e?.close()),(()=>{}))}getOrder(){return this.#t}getSymbolCount(){return this.#s.length}getSymbolIndex(e){return this.#o.get(e)}getSymbolString(e){return this.#s[e]?.nGram[0]}async lookup(e){const t=(await this.lookupRange(e))[Symbol.iterator](),n=t.next().value;return t.return?.(),n&&e.every(((e,t)=>e===n.nGram[t]))?n:null}async lookupRange(t,n){const s=this.#c(t.at(-1)),o=n?this.#c(n.at(-1)):this.#s.length;if(1===t.length){const e=this;return function*(){for(let t=s;t<o;++t)yield e.#s[t]}()}const r=this.#d(t);if(null===r)return[];const i=await this.#n,a=t.length.toString(),l=i.transaction(a,"readonly").objectStore(a),c=await e(l.get(r));if(!c)return[];const d=t.length<i.objectStoreNames.length,h=this.#h(d);let m=0,u=c.byteLength/h;for(;m<u;){const e=m+u>>1,t=new DataView(c.buffer,c.byteOffset+e*h);this.#m(t)<s?m=e+1:u=e}const g=this;return function*(){let e=m*h;const n=t.slice(0,-1);for(;e<c.byteLength;){const t=new DataView(c.buffer,c.byteOffset+e,h),s=g.#u(t);if(s.symbolIndex>=o)break;yield Object.assign({nGram:n.concat([g.getSymbolString(s.symbolIndex)]),p:s.p},d?{backoff:s.backoff}:{}),e+=h}}()}#c(e){let t=0,n=this.#s.length;for(;t<n;){const s=t+n>>1;this.getSymbolString(s)<e?t=s+1:n=s}return t}async beginLoad(t){await this.close(),await e(indexedDB.deleteDatabase(this.#e)),this.#t=t,this.#n=new Promise(((e,n)=>{const s=indexedDB.open(this.#e,1);s.onupgradeneeded=()=>{const e=s.result;for(let n=1;n<=t;n++)e.createObjectStore(n.toString())},s.onsuccess=()=>e(s.result),s.onerror=()=>n(s.error)}))}async addNGram(e,t,n){(e.length>this.#r[0]?.tuple.length||e.some(((t,n)=>n+1<e.length&&t!==this.#r[0]?.tuple[n])))&&await this.#g(),this.#r.push({tuple:e,p:t,backoff:n})}async endLoad(){this.#r.length&&await this.#g()}async#g(){this.#r.sort(((e,t)=>{const n=e.tuple.at(-1),s=t.tuple.at(-1);return n<s?-1:n>s?1:0}));const e=this.#r[0].tuple.length;if(1===e){this.#s=this.#r.map((({tuple:[e],p:t,backoff:n},s)=>(this.#o.set(e,s),{nGram:[e],p:t,backoff:n})));for(let e=0;e<this.#s.length;++e)await this.#f(1,e,this.#s[e])}else{const t=e<this.#t,n=this.#h(t),s=new Uint8Array(this.#r.length*n);this.#r.forEach((({tuple:e,p:t,backoff:o},r)=>{const i=new DataView(s.buffer,s.byteOffset+r*n,n);this.#p(i,e.at(-1),t,o)}));const o=this.#d(this.#r[0].tuple);await this.#f(e,o,s)}this.#r=[]}async#f(e,t,n){this.#l+1e3<performance.now()&&(this.#i?.commit(),await this.#a);for(let s=0;s<2;++s)try{if(!this.#i){const e=await this.#n,t=Array.from(e.objectStoreNames),n=new Promise(((n,s)=>{this.#i=e.transaction(t,"readwrite",{durability:"relaxed"}),this.#i.oncomplete=()=>{this.#i=null,n()},this.#i.onerror=()=>s(this.#i.error)}));this.#a=this.#a.then((()=>n)),this.#l=performance.now()}this.#i.objectStore(e.toString()).put(n,t)}catch(e){if("TransactionInactiveError"!==e.name)throw e;this.#i=null}}#d(e){const t=[];for(let n=0;n+1<e.length;++n){const s=this.getSymbolIndex(e[n]);if(void 0===s)return null;t.push(s)}return t.reduce(((e,t)=>65536*e+t),0)}#h(e){return e?6:4}#p(e,t,n,s){return e.setUint16(0,this.#o.get(t)),e.setUint16(2,Math.round(1024*-n)),e.byteLength>=6&&void 0!==s&&e.setUint16(4,Math.round(1024*-s)),new Uint8Array(e.buffer)}#u(e){const t=e.byteLength===this.#h(!0);return{symbolIndex:e.getUint16(0),p:-e.getUint16(2)/1024,backoff:t?-e.getUint16(4)/1024:void 0}}#m(e){return e.getUint16(0)}}("test"),s=new class{#f;constructor(e){this.#f=e}async complete(e){const t=new Map;return await this.#y(e.slice(-this.#f.getOrder()),0,t),Array.from(t.values()).sort(((e,t)=>t.p-e.p))}async#y(e,t,n){const s=e.length,o=await this.#f.lookupRange(e,[e.slice(0,-1),e.at(-1)+"ï¿¿"]);for(const e of o){const o=e.nGram.at(-1);n.has(o)||n.set(o,{word:o,order:s,p:t+e.p})}if(s>1){const s=await this.#f.lookup(e.slice(0,-1));s&&await this.#y(e.slice(1),t+s.backoff,n)}}}(n);document.getElementById("load-local").addEventListener("change",(async e=>{const s=e.target;if(s.files.length){const e=s.files.item(0),a=new o;a.addEventListener("progress",(t=>{r(),i(`Reading: ${e.name} ${(t.detail/e.size*100).toFixed(0)}%`)}));let l=e.stream().pipeThrough(new TransformStream(a));e.name.endsWith(".gz")&&(l=l.pipeThrough(new DecompressionStream("gzip"))),await t(n,l),r();const c=await navigator.storage.estimate().then((({usage:e,usageDetails:t})=>t?.indexedDB??e));i("Loading complete."),i(`IndexedDB storage: ${c} bytes`)}})),document.getElementById("text").addEventListener("input",(async e=>{r();const t=e.target.value.trimStart().split(/\s+/);if(t.length){const e=performance.now(),n=await s.complete(t);i(`Elapsed ${(performance.now()-e).toFixed(1)} ms`),i(`${n.length} completions (up to 15 shown):`),n.slice(0,16).forEach((e=>{i(e.word,e.p.toFixed(3),`(${e.order})`)}))}}));class o extends EventTarget{constructor(){super(),this.bytesRead=0}async transform(e,t){t.enqueue(e),this.bytesRead+=e.length,this.dispatchEvent(new CustomEvent("progress",{detail:this.bytesRead}))}}function r(){document.getElementById("results").innerHTML=""}function i(...e){const t=document.getElementById("results"),n=document.createElement("pre");n.textContent=e.map((e=>e.toString())).join(" "),t.appendChild(n)}
//# sourceMappingURL=arpa.js.map
